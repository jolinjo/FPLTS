# 測試計劃文件 (Test Plan)

## 概述

本文檔定義了工廠製程物流追溯與分析系統的完整測試計劃，涵蓋所有功能模組和業務邏輯的測試項目。

---

## 測試分類

### 1. 單元測試 (Unit Tests)

#### 1.1 條碼處理模組 (`services/barcode.py`)

##### 1.1.1 條碼解析測試
- [ ] **測試完整條碼解析**
  - 正確格式的 34 碼條碼應能成功解析
  - 解析結果應包含所有欄位（order, process, sku, container, box_seq, status, qty, crc）
  - 測試案例：`251119AA-P2-ST352-A1-01-G-0100-X4F`

- [ ] **測試錯誤格式條碼**
  - 長度不符合的條碼應返回 None
  - 格式不符合的條碼應返回 None
  - 缺少分隔符號的條碼應返回 None

- [ ] **測試部分條碼解析**
  - ZZ 製程條碼（新工單）應能部分解析
  - 測試案例：`251119AB-ZZ-AC001`
  - 測試案例：`251119AB-ZZ`（只有工單和製程）
  - 測試包含 `b=` 前綴的條碼

- [ ] **測試 SKU 提取**
  - `get_series_from_sku()` 應正確提取前 2 碼
  - `get_model_from_sku()` 應正確提取後 3 碼
  - 測試邊界情況（空字串、長度不足）

##### 1.1.2 CRC16 校驗測試
- [ ] **測試 CRC16 計算**
  - 計算結果應為 3 碼十六進位字串（大寫）
  - 相同輸入應產生相同校驗碼
  - 測試已知條碼的校驗碼計算

- [ ] **測試 CRC16 驗證**
  - 正確的條碼應通過驗證
  - 錯誤的校驗碼應驗證失敗
  - 格式錯誤的條碼應驗證失敗

##### 1.1.3 條碼生成測試
- [ ] **測試完整條碼生成**
  - 生成的新條碼應符合 34 碼格式
  - 生成的條碼應包含正確的 CRC16 校驗碼
  - 測試案例：生成首站條碼

- [ ] **測試從舊條碼生成新條碼**
  - 應正確更新製程代號
  - 應正確更新容器、箱號、貨態、數量（如果提供）
  - 應保留工單號和 SKU
  - 測試案例：P1 條碼遷出生成 P2 條碼

- [ ] **測試欄位格式化**
  - 工單號應補零或截斷至 8 碼
  - 製程代號應補零或截斷至 2 碼
  - SKU 應補零或截斷至 5 碼
  - 箱號應補零至 2 碼
  - 數量應補零至 4 碼

#### 1.2 配置載入模組 (`services/config_loader.py`)

- [ ] **測試配置檔載入**
  - 所有 INI 檔應成功載入
  - 不存在的配置檔應優雅處理（警告但不中斷）

- [ ] **測試配置值讀取**
  - `get_value()` 應正確讀取配置值
  - 不存在的鍵值應返回預設值
  - `get_section_dict()` 應返回完整的區段字典

- [ ] **測試配置檔類型**
  - process.ini（製程站點）
  - series.ini（產品系列）
  - model.ini（機種）
  - container.ini（容器）
  - status.ini（貨態）
  - settings.ini（設定）

#### 1.3 Google Sheets 服務模組 (`services/sheet.py`)

- [ ] **測試記錄寫入**
  - 應成功寫入記錄到 Google Sheets
  - 時間戳記應正確格式化
  - 所有欄位應正確對應

- [ ] **測試記錄查詢**
  - `get_logs_by_barcode()` 應返回匹配的記錄
  - `get_logs_by_order()` 應返回匹配的記錄
  - 應正確處理包含 domain 的條碼（`/b=` 前綴）

- [ ] **測試記錄檢查**
  - `has_inbound_record()` 應正確檢查遷入記錄
  - `has_outbound_record()` 應正確檢查遷出記錄
  - `has_inbound_record_at_station()` 應正確檢查指定站點的遷入記錄
  - `has_outbound_record_at_station()` 應正確檢查指定站點的遷出記錄
  - `has_outbound_record_at_downstream_stations()` 應正確檢查下游站點的遷出記錄

- [ ] **測試錯誤處理**
  - Google Sheets 連接失敗應優雅處理
  - 憑證錯誤應顯示適當訊息
  - 工作表不存在應優雅處理

#### 1.5 QR Code 生成模組 (`services/qrcode_generator.py`)

- [ ] **測試 QR Code 生成**
  - 應生成有效的 SVG 格式 QR Code
  - QR Code 內容應包含完整的條碼 URL
  - 應正確處理包含 domain 的 URL

---

### 2. API 端點測試 (API Endpoint Tests)

#### 2.1 配置查詢 API

- [ ] **GET /api/config/series**
  - 應返回所有產品線選項
  - 返回格式應包含 code 和 name

- [ ] **GET /api/config/models**
  - 應返回所有機種選項
  - 返回格式應包含 code 和 name

- [ ] **GET /api/config/containers**
  - 應返回所有容器選項
  - 返回格式應包含 code 和 capacity

- [ ] **GET /api/config/processes**
  - 應返回所有製程站點選項
  - 返回格式應包含 code 和 name

#### 2.2 條碼檢查 API (`POST /api/scan/check`)

- [ ] **測試 ZZ 製程（新工單）**
  - 應返回 `suggested_action: "first"`
  - 應自動提取工單號、產品線、機種（如果存在）

- [ ] **測試上一站條碼 + 下游已有遷出記錄**
  - 應返回 `suggested_action: "trace"`
  - 應提示只能查詢，不能遷入或遷出

- [ ] **測試當前站點已有遷入記錄**
  - 應返回 `suggested_action: "outbound"`
  - 應提示使用遷出功能

- [ ] **測試當前站點已有遷出記錄**
  - 應返回 `suggested_action: "outbound"`
  - 應提示可以再次遷出

- [ ] **測試沒有記錄的情況**
  - 上一站條碼 → 應返回 `suggested_action: "inbound"`
  - 本站條碼 → 應返回 `suggested_action: "inbound"`
  - 下一站條碼 → 應返回 `suggested_action: "inbound"`

- [ ] **測試錯誤處理**
  - 條碼格式錯誤應返回 400
  - 校驗碼錯誤應返回 400（ZZ 製程除外）

#### 2.3 遷入 API (`POST /api/scan/inbound`)

- [ ] **測試正常遷入流程**
  - 上一站條碼在當前站點沒有記錄 → 應成功遷入
  - 應執行流程驗證
  - 應寫入 Google Sheets（背景任務）

- [ ] **測試防呆檢查**
  - 跳站應返回 400 錯誤
  - 漏站應返回 400 錯誤
  - 錯誤訊息應清楚說明問題

- [ ] **測試重複遷入防護**
  - 當前站點已有遷入記錄 → 應返回 `should_switch_to_outbound: true`
  - 當前站點已有遷出記錄 → 應返回 `should_switch_to_outbound: true`

- [ ] **測試錯誤處理**
  - 條碼格式錯誤應返回 400
  - 校驗碼錯誤應返回 400
  - 缺少必要參數應返回 422

#### 2.4 遷出 API (`POST /api/scan/outbound`)

- [ ] **測試正常遷出流程**
  - 應成功生成新條碼（更新製程代號）
  - 應保留工單號和 SKU
  - 應允許更新容器、箱號、貨態、數量
  - 應寫入 Google Sheets（背景任務）

- [ ] **測試新條碼生成**
  - 新條碼應包含正確的製程代號（當前站點）
  - 新條碼應包含正確的 CRC16 校驗碼
  - 應返回包含 domain 的完整 URL

- [ ] **測試 QR Code 生成**
  - 應返回 SVG 格式的 QR Code
  - QR Code 應包含完整的條碼 URL

- [ ] **測試下一站建議**
  - 應根據 flow.ini 返回正確的下一站
  - 最後一站應返回 None

- [ ] **測試錯誤處理**
  - 條碼格式錯誤應返回 400
  - 校驗碼錯誤應返回 400
  - 生成條碼失敗應返回 500

#### 2.5 首站遷出 API (`POST /api/scan/first`)

- [ ] **測試正常首站遷出**
  - 應成功生成第一個條碼
  - 應正確組合 SKU（產品線 + 機種）
  - 應寫入 Google Sheets（背景任務）

- [ ] **測試參數驗證**
  - 無效的產品線代號應返回 400
  - 無效的機種代號應返回 400
  - 缺少必要參數應返回 422

- [ ] **測試 SKU 組合**
  - 產品線代號（2碼）+ 機種代號（3碼，補零）應正確組合
  - 測試案例：AC + 350 → AC350
  - 測試案例：ST + 1 → ST001

- [ ] **測試 QR Code 生成**
  - 應返回 SVG 格式的 QR Code

#### 2.6 追溯查詢 API (`POST /api/scan/trace`)

- [ ] **測試正常追溯查詢**
  - 應返回該工單的所有記錄
  - 應按製程站點分組
  - 應計算投入數量、產出數量、總耗時間

- [ ] **測試統計數據計算**
  - 總數 = 首站遷出的良品與不良品加總
  - 最終站的良品和不良品數量應正確計算
  - 不良率 = 不良品/總數
  - 良率 = 良品/總數
  - 各製程站的良率應正確計算

- [ ] **測試時間軸排序**
  - 站點應按最早時間排序
  - 每個站點的記錄應按時間排序

- [ ] **測試時間格式解析**
  - 應支援多種時間格式
  - 無效的時間戳記應優雅處理

- [ ] **測試錯誤處理**
  - 條碼格式錯誤應返回 400
  - 沒有記錄應返回空列表

#### 2.7 路由測試

- [ ] **GET /**
  - 應返回前端頁面（index.html）
  - 如果檔案不存在應返回 API 訊息

- [ ] **GET /b={barcode:path}**
  - 應重定向到 `/?b={barcode}`
  - 應支援 QR code 中沒有 `?` 的情況

---

### 3. 業務邏輯測試 (Business Logic Tests)

#### 3.1 條碼掃描邏輯測試（根據 BARCODE_SCAN_LOGIC.md）

- [ ] **測試情況 1：ZZ 製程（新工單）**
  - 無論當前站點為何，都應使用首站遷出
  - 不需要檢查歷史記錄
  - 不需要驗證 CRC16

- [ ] **測試情況 2：上一站條碼**
  - 上一站條碼 + 當前站點或下游站點已有遷出記錄 → 只允許查詢
  - 上一站條碼 + 當前站點已有遷入記錄 → 遷出
  - 上一站條碼 + 當前站點已有遷出記錄（但下游沒有）→ 遷出
  - 上一站條碼 + 當前站點沒有記錄 → 遷入

- [ ] **測試情況 3：本站條碼**
  - 本站條碼 + 當前站點已有遷入記錄 → 遷出
  - 本站條碼 + 當前站點已有遷出記錄 → 遷出
  - 本站條碼 + 當前站點沒有記錄 → 遷入（可能是異常）

- [ ] **測試情況 4：下一站條碼**
  - 下一站條碼 + 當前站點已有遷入記錄 → 遷出
  - 下一站條碼 + 當前站點已有遷出記錄 → 遷出
  - 下一站條碼 + 當前站點沒有記錄 → 遷入（可能是跳站異常）

#### 3.2 流程防呆測試

- [ ] **測試正常流程**
  - P1 → P2 → P3 → P4 → P5（ST 系列）
  - P1 → P3 → P5（AC 系列）
  - P1 → P3 → P4 → P5（MD 系列）

- [ ] **測試跳站防呆**
  - P1 → P3（跳過 P2）應被阻止
  - P2 → P5（跳過 P3, P4）應被阻止

- [ ] **測試漏站防呆**
  - P1 → P4（漏掉 P2, P3）應被阻止

- [ ] **測試反向移動防呆**
  - P2 → P1 應被阻止
  - P3 → P2 應被阻止

#### 3.3 數據完整性測試

- [ ] **測試防止數據錯亂機制**
  - 條碼已流到下游站點後，不應允許在當前站點遷入或遷出
  - 只應允許查詢

- [ ] **測試多次遷出支援**
  - 同一條碼在同一站點可以多次遷出（例如：分為良品和不良品）
  - 但前提是條碼沒有流到下游站點

- [ ] **測試遷入記錄優先於遷出記錄**
  - 如果同時有遷入和遷出記錄，優先檢查遷入記錄
  - 有遷入記錄 → 必須先遷出

---

### 4. 整合測試 (Integration Tests)

#### 4.1 完整工作流程測試

- [ ] **測試完整生產流程**
  1. 首站遷出（生成 P1 條碼）
  2. P1 站點遷出（生成 P2 條碼）
  3. P2 站點遷入
  4. P2 站點遷出（生成 P3 條碼）
  5. P3 站點遷入
  6. P3 站點遷出（生成 P4 條碼）
  7. P4 站點遷入
  8. P4 站點遷出（生成 P5 條碼）
  9. P5 站點遷入
  10. P5 站點遷出（完成）
  11. 追溯查詢（驗證所有記錄）

- [ ] **測試 AC 系列流程（跳過 P2, P4）**
  1. 首站遷出（生成 P1 條碼）
  2. P1 站點遷出（生成 P3 條碼）
  3. P3 站點遷入
  4. P3 站點遷出（生成 P5 條碼）
  5. P5 站點遷入
  6. P5 站點遷出（完成）

- [ ] **測試分為良品和不良品**
  1. P2 站點遷入
  2. P2 站點遷出（良品，生成 P3 條碼）
  3. P2 站點遷出（不良品，生成 P3 條碼，不同容器）

#### 4.2 Google Sheets 整合測試

- [ ] **測試記錄寫入和讀取**
  - 寫入記錄後應能立即查詢到
  - 時間戳記應正確記錄
  - 所有欄位應正確對應

- [ ] **測試多筆記錄查詢**
  - 同一工單的多筆記錄應能正確查詢
  - 同一條碼的多筆記錄應能正確查詢

- [ ] **測試記錄檢查功能**
  - 遷入後應能檢查到遷入記錄
  - 遷出後應能檢查到遷出記錄
  - 下游站點檢查應正確工作

---

### 5. 錯誤處理測試 (Error Handling Tests)

#### 5.1 輸入驗證測試

- [ ] **測試無效條碼**
  - 空字串
  - 長度不符合
  - 格式不符合
  - 缺少必要欄位

- [ ] **測試無效參數**
  - 缺少必要參數（operator_id, current_station_id）
  - 無效的站點代號
  - 無效的產品線代號
  - 無效的機種代號

#### 5.2 異常情況測試

- [ ] **測試 Google Sheets 連接失敗**
  - 憑證錯誤應優雅處理
  - 網路錯誤應優雅處理
  - 工作表不存在應優雅處理

- [ ] **測試配置檔缺失**
  - 缺少 flow.ini 應優雅處理
  - 缺少其他配置檔應優雅處理

- [ ] **測試邊界情況**
  - 空的工作表
  - 只有標題列的工作表
  - 格式不正確的工作表

---

### 6. 性能測試 (Performance Tests)

- [ ] **測試 API 響應時間**
  - 遷入 API 應在 1 秒內響應（不等待 Google Sheets 寫入）
  - 遷出 API 應在 1 秒內響應
  - 追溯查詢 API 應在 2 秒內響應（取決於記錄數量）

- [ ] **測試背景任務**
  - Google Sheets 寫入應在背景執行，不阻塞 API 響應
  - 多個並發請求應正確處理

- [ ] **測試大量記錄查詢**
  - 查詢包含大量記錄的工單應在合理時間內完成
  - 應正確限制返回筆數

---

### 7. 安全性測試 (Security Tests)

- [ ] **測試輸入清理**
  - SQL 注入防護（雖然使用 Google Sheets，但應確保輸入清理）
  - XSS 防護（前端應正確處理用戶輸入）

- [ ] **測試權限控制**
  - 操作員 ID 應正確記錄
  - 應驗證操作員 ID 格式（如果有的話）

---

### 8. 前端測試 (Frontend Tests)

#### 8.1 UI 功能測試

- [ ] **測試設定頁面**
  - 工號輸入應正確保存到 localStorage
  - 站點選擇應正確保存
  - 未設定工號應鎖定在設定頁

- [ ] **測試條碼掃描**
  - URL 參數讀取應正確處理
  - 條碼檢查應正確調用 API
  - 應根據檢查結果自動切換功能

- [ ] **測試遷入功能**
  - 應正確調用遷入 API
  - 成功應顯示綠色卡片
  - 流程錯誤應顯示紅色警示

- [ ] **測試遷出功能**
  - 應正確調用遷出 API
  - 應顯示新條碼和 QR Code
  - 應顯示下一站建議

- [ ] **測試首站遷出功能**
  - 應正確調用首站遷出 API
  - 應顯示生成的條碼和 QR Code

- [ ] **測試追溯查詢功能**
  - 應正確調用追溯查詢 API
  - 應正確顯示時間軸
  - 應正確顯示統計數據

#### 8.2 用戶體驗測試

- [ ] **測試響應式設計**
  - 應在手機上正確顯示
  - 應在平板電腦上正確顯示

- [ ] **測試音效和震動**
  - 成功操作應播放成功音效
  - 錯誤操作應播放錯誤音效
  - 流程錯誤應觸發震動

---

## 測試環境需求

### 測試環境設定

1. **Python 環境**
   - Python 3.12+
   - 安裝所有依賴套件（requirements.txt）

2. **Google Sheets 測試環境**
   - 測試用的 Google Sheet ID
   - Service Account 憑證檔案
   - 測試用的工作表（Logs）

3. **配置檔**
   - 所有 INI 配置檔應存在
   - 應包含測試用的數據

4. **測試數據**
   - 準備測試用的條碼
   - 準備測試用的工單號
   - 準備測試用的記錄（如果需要）

---

## 測試執行計劃

### 階段 1：單元測試
- 優先測試核心模組（barcode, config_loader, flow_validator）
- 確保基礎功能正常

### 階段 2：API 測試
- 測試所有 API 端點
- 確保 API 響應正確

### 階段 3：業務邏輯測試
- 測試完整的業務流程
- 確保防呆機制正常運作

### 階段 4：整合測試
- 測試完整工作流程
- 測試 Google Sheets 整合

### 階段 5：錯誤處理和性能測試
- 測試各種錯誤情況
- 測試性能表現

---

## 測試工具建議

1. **pytest** - Python 測試框架
2. **pytest-asyncio** - 非同步測試支援
3. **pytest-mock** - Mock 物件支援
4. **httpx** - HTTP 客戶端（用於 API 測試）
5. **pytest-cov** - 測試覆蓋率

---

## 測試覆蓋率目標

- **單元測試覆蓋率**：≥ 80%
- **API 測試覆蓋率**：100%（所有端點）
- **業務邏輯測試覆蓋率**：100%（所有情況組合）

---

## 注意事項

1. **Google Sheets 測試**
   - 建議使用獨立的測試工作表
   - 測試後應清理測試數據
   - 或使用 Mock 物件模擬 Google Sheets

2. **背景任務測試**
   - 背景任務（Google Sheets 寫入）應使用 Mock 或測試模式
   - 確保測試不會實際寫入生產數據

3. **配置檔測試**
   - 測試應使用獨立的測試配置檔
   - 或使用 Mock 物件模擬配置載入

4. **時間相關測試**
   - 時間戳記測試應考慮時區
   - 工時計算測試應考慮時間差異

---

## 更新記錄

- 2025-01-XX: 初始版本，定義所有測試項目

