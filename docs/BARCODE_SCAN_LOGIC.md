# 條碼掃描邏輯定義文件

## 概述

本文檔定義了系統在掃描條碼後的所有可能狀態和對應的行為邏輯。系統需要根據條碼的製程代號、當前站點、以及歷史記錄來決定應該開啟哪個功能（遷入/遷出/首站遷出）。

## 變數定義

### 1. 條碼製程代號 (barcode_process)
- **ZZ**: 新工單（第一站）
- **P1, P2, P3, P4, P5**: 各製程站點代號
- **其他**: 未定義的製程代號

### 2. 當前站點 (current_station)
- **P1, P2, P3, P4, P5**: 操作員當前所在的站點

### 3. 條碼與當前站點的關係
- **上一站**: `barcode_process < current_station`（例如：P1 條碼在 P2 站點）
- **本站**: `barcode_process == current_station`（例如：P2 條碼在 P2 站點）
- **下一站**: `barcode_process > current_station`（例如：P3 條碼在 P2 站點）
- **第一站**: `barcode_process == 'ZZ'`（新工單）

### 4. 歷史記錄狀態
- **has_in_at_current**: 該條碼在當前站點是否有遷入（IN）記錄
- **has_out_at_current**: 該條碼在當前站點是否有遷出（OUT）記錄
- **has_out_at_downstream**: 該條碼在下游站點是否有遷出（OUT）記錄
- **has_in_anywhere**: 該條碼在任何站點是否有遷入記錄
- **has_out_anywhere**: 該條碼在任何站點是否有遷出記錄

## 狀態組合與行為定義

### 情況 1: ZZ 製程（新工單）

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process == 'ZZ'` | **開啟首站遷出** | 無論當前站點為何，ZZ 製程都應該使用首站遷出功能 |

**邏輯**：
- 不需要檢查歷史記錄
- 自動填入工單號（從條碼中提取）
- 自動填入產品線和機種（如果條碼中包含 SKU）

---

### 情況 2: 上一站條碼（barcode_process < current_station）

#### 2.0: 上一站條碼 + 當前站點或下游站點已有遷出記錄（防止數據錯亂）

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process < current_station` AND (`has_out_at_current == true` OR `has_out_at_downstream == true`) | **只允許查詢** | 防止數據錯亂，不允許遷入或遷出 |

**邏輯**：
- **優先檢查**：如果當前站點或下游站點已有遷出記錄，說明條碼已經流到下游
- 只允許查詢功能，不允許遷入或遷出
- 提示：該條碼在當前站點或下游站點已有遷出記錄，為避免數據錯亂，只能進行查詢
- 自動開啟追溯查詢功能
- 自動填入條碼

#### 2.1: 上一站條碼 + 當前站點已有遷入記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process < current_station` AND `has_in_at_current == true` AND `has_out_at_current == false` AND `has_out_at_downstream == false` | **開啟遷出** | 已經遷入過，應該遷出 |

**邏輯**：
- 檢查到當前站點已有遷入記錄
- 且當前站點和下游站點都沒有遷出記錄
- 自動開啟遷出功能
- 自動填入條碼
- 提示：該條碼在當前站點已有遷入記錄，請使用遷出功能

#### 2.2: 上一站條碼 + 當前站點已有遷出記錄（但下游沒有）

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process < current_station` AND `has_out_at_current == true` AND `has_out_at_downstream == false` | **開啟遷出** | 已經遷出過，可以再次遷出（例如：分為良品和不良品） |

**邏輯**：
- 檢查到當前站點已有遷出記錄
- 但下游站點沒有遷出記錄（說明還沒流到下游）
- 自動開啟遷出功能
- 自動填入條碼
- 提示：該條碼在當前站點已有遷出記錄，可以再次遷出

#### 2.3: 上一站條碼 + 當前站點沒有記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process < current_station` AND `has_in_at_current == false` AND `has_out_at_current == false` AND `has_out_at_downstream == false` | **開啟遷入** | 從上游站點遷入到當前站點 |

**邏輯**：
- 檢查到當前站點和下游站點都沒有記錄
- 自動開啟遷入功能
- 自動填入條碼
- 執行流程驗證（防呆檢查）

---

### 情況 3: 本站條碼（barcode_process == current_station）

#### 3.1: 本站條碼 + 當前站點已有遷入記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process == current_station` AND `has_in_at_current == true` | **開啟遷出** | 已經遷入過，應該遷出 |

**邏輯**：
- 檢查到當前站點已有遷入記錄
- 自動開啟遷出功能
- 自動填入條碼
- 提示：該條碼在當前站點已有遷入記錄，請使用遷出功能

#### 3.2: 本站條碼 + 當前站點已有遷出記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process == current_station` AND `has_out_at_current == true` | **開啟遷出** | 已經遷出過，可以再次遷出（例如：分為良品和不良品） |

**邏輯**：
- 檢查到當前站點已有遷出記錄
- 自動開啟遷出功能
- 自動填入條碼
- 提示：該條碼在當前站點已有遷出記錄，可以再次遷出

#### 3.3: 本站條碼 + 當前站點沒有記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process == current_station` AND `has_in_at_current == false` AND `has_out_at_current == false` | **開啟遷入** | 可能是異常情況，但允許遷入 |

**邏輯**：
- 檢查到當前站點沒有記錄
- 自動開啟遷入功能
- 自動填入條碼
- 執行流程驗證（防呆檢查）
- 注意：這種情況可能是異常，但系統允許操作

---

### 情況 4: 下一站條碼（barcode_process > current_station）

#### 4.1: 下一站條碼 + 當前站點已有遷入記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process > current_station` AND `has_in_at_current == true` | **開啟遷出** | 已經遷入過，應該遷出 |

**邏輯**：
- 檢查到當前站點已有遷入記錄
- 自動開啟遷出功能
- 自動填入條碼
- 提示：該條碼在當前站點已有遷入記錄，請使用遷出功能

#### 4.2: 下一站條碼 + 當前站點已有遷出記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process > current_station` AND `has_out_at_current == true` | **開啟遷出** | 已經遷出過，可以再次遷出 |

**邏輯**：
- 檢查到當前站點已有遷出記錄
- 自動開啟遷出功能
- 自動填入條碼
- 提示：該條碼在當前站點已有遷出記錄，可以再次遷出

#### 4.3: 下一站條碼 + 當前站點沒有記錄

| 條件 | 行為 | 說明 |
|------|------|------|
| `barcode_process > current_station` AND `has_in_at_current == false` AND `has_out_at_current == false` | **開啟遷入** | 可能是異常情況（跳站），但允許遷入 |

**邏輯**：
- 檢查到當前站點沒有記錄
- 自動開啟遷入功能
- 自動填入條碼
- 執行流程驗證（防呆檢查）
- 注意：這種情況可能是異常（跳站），但系統允許操作

---

## 決策流程圖

```
開始掃描條碼
    |
    v
解析條碼，取得製程代號 (barcode_process)
    |
    v
是 ZZ 製程？
    | 是 -> 開啟首站遷出
    | 否
    v
判斷條碼與當前站點的關係
    |
    +-- 上一站條碼？
    |   |
    |   v
    |   檢查當前站點或下游站點是否有遷出記錄
    |   |
    |   | 是 -> 只允許查詢（防止數據錯亂）
    |   | 否
    |   v
    |   繼續檢查其他條件
    |
    +-- 本站條碼 -> 繼續檢查
    |
    +-- 下一站條碼 -> 繼續檢查
    |
    v
檢查當前站點是否有遷入記錄 (has_in_at_current)
    |
    | 是 -> 開啟遷出功能
    | 否
    v
檢查當前站點是否有遷出記錄 (has_out_at_current)
    |
    | 是 -> 開啟遷出功能
    | 否
    v
根據條碼與站點關係決定
    |
    +-- 上一站 -> 開啟遷入功能（執行流程驗證）
    |
    +-- 本站 -> 開啟遷入功能（執行流程驗證，可能是異常）
    |
    +-- 下一站 -> 開啟遷入功能（執行流程驗證，可能是跳站異常）
```

## 優先級順序

1. **最高優先級**: ZZ 製程 → 首站遷出
2. **第二優先級**: 上一站條碼 + 當前站點或下游站點已有遷出記錄 → 只允許查詢（防止數據錯亂）
3. **第三優先級**: 當前站點已有遷入記錄 → 遷出
4. **第四優先級**: 當前站點已有遷出記錄 → 遷出
5. **最低優先級**: 沒有記錄 → 遷入（根據條碼與站點關係執行流程驗證）

## 檢查時機

### 1. URL 參數讀取時（processPendingBarcode）
- 從 URL 讀取條碼後立即檢查
- 根據檢查結果自動開啟對應功能
- 不需要等待用戶操作

### 2. 遷入功能提交時（handleInbound）
- 用戶點擊遷入按鈕時再次檢查
- 如果檢查到已有遷入記錄，自動切換到遷出功能
- 防止重複遷入

## 錯誤處理

### 條碼格式錯誤
- 無法解析條碼 → 顯示錯誤訊息
- 校驗碼錯誤 → 顯示錯誤訊息（ZZ 製程除外）

### 流程驗證失敗
- 跳站或漏站 → 顯示流程錯誤訊息
- 不允許繼續操作

## 注意事項

1. **ZZ 製程特殊處理**：
   - 不需要驗證 CRC16 校驗碼
   - 不需要檢查歷史記錄
   - 不需要執行流程驗證

2. **防止數據錯亂機制**：
   - 如果上一站條碼在當前站點或下游站點已有遷出記錄，只允許查詢
   - 這是為了防止條碼已經流到下游後，又被重新遷入或遷出，導致數據錯亂
   - 系統會自動開啟追溯查詢功能，並顯示提示訊息

3. **遷入記錄優先於遷出記錄**：
   - 如果同時有遷入和遷出記錄，優先檢查遷入記錄
   - 有遷入記錄 → 必須先遷出

4. **多次遷出支援**：
   - 允許同一條碼在同一站點多次遷出
   - 例如：分為良品和不良品兩批遷出
   - 但前提是條碼沒有流到下游站點

5. **異常情況處理**：
   - 本站條碼或下一站條碼在當前站點沒有記錄，可能是異常情況
   - 系統允許操作，但會執行流程驗證

## 更新記錄

- 2025-01-XX: 初始版本，定義所有狀態組合和行為邏輯

