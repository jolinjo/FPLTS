# 更新日誌 (Changelog)

所有重要的變更都會記錄在此文件中。

格式基於 [Keep a Changelog](https://keepachangelog.com/zh-TW/1.0.0/)，
版本號遵循 [Semantic Versioning](https://semver.org/lang/zh-TW/)。

## [0.2.1] - 2025-01-XX

### 新增
- **嚴格遵守 Apple Human Interface Guidelines**：
  - 所有前端頁面設計完全符合 Apple HIG 規範
  - 在 PRD.md 中新增詳細的 UI/UX 設計規範章節
  - 包含設計原則、具體設計規範、頁面特定規範和參考資源

### 改進
- **全面 UI 重構 - Apple 風格設計**：
  - 使用 iOS 標準顏色系統（系統藍色、綠色、紅色、橙色、紫色等）
  - 統一字體系統：大標題 28px、標題 22px、正文 17px、小字 15px、標籤 13px
  - 統一間距系統：使用 8px 基礎單位（8px、16px、24px、32px）
  - 按鈕樣式：44px 最小觸控目標，10px 圓角，符合 iOS 標準
  - 卡片樣式：16px 圓角，適當的陰影效果
  - 輸入框樣式：12px 圓角，44px 最小高度
  - 優化主頁面佈局：標題大小調整、視覺區劃改善、設定按鈕位置優化
  - 訊息顯示區域：固定留白空間，位於功能選單上方
- **功能按鈕優化**：
  - 使用 iOS 標準顏色（綠色=遷入、藍色=遷出、紫色=追溯、橙色=首站）
  - 添加 `pointer-events: auto` 和 `user-select: none` 確保可點擊
  - 優化 hover 和 active 狀態效果
- **JavaScript 錯誤修復**：
  - 為所有事件監聽器添加空值檢查，避免 `null` 引用錯誤
  - 修復 checkbox 事件監聽器缺少空值檢查的問題
  - 修復下載按鈕事件監聽器缺少空值檢查的問題
  - 確保所有功能按鈕都能正常運作

### 修復
- 修復功能按鈕無法點擊的問題
- 修復 JavaScript 控制台錯誤：`Cannot read properties of null (reading 'addEventListener')`
- 修復按鈕樣式衝突導致的點擊問題
- 確保所有 UI 元素都有正確的事件綁定

## [0.2.0] - 2025-01-XX

### 新增
- **遷出功能重大改進 - 同時處理良品與不良品**：
  - 遷出頁面重新設計，支援同時設定良品和不良品的數量和容器
  - 使用卡片式布局，良品使用綠色卡片，不良品使用紅色卡片，視覺清晰
  - 每個卡片包含：數量輸入框、容器選擇下拉選單、自動計算的箱數預覽
  - 系統會分別為良品和不良品自動計算箱數並生成條碼
  - 結果頁面分組顯示良品和不良品箱子，使用不同顏色區分
- **投入量顯示功能**：
  - 遷出頁面頂部顯示當前站點的投入量（遷入總數量）
  - 使用藍色卡片樣式，與遷出資訊一致
  - 自動解析條碼獲取工單號並查詢投入量
  - 新增後端 API `/api/scan/inbound-quantity` 用於查詢投入量
- **防呆驗證 - 數量一致性檢查**：
  - 遷出提交前自動驗證：良品數量 + 不良品數量 = 投入量
  - 如果數量不符，顯示簡潔的錯誤訊息並阻止提交
  - 錯誤訊息格式：`加總 X 件與投入量 Y 件不符`
  - 確保數據一致性，防止數量錯誤
- **批量遷入功能**：
  - 遷入時自動查詢相同工單的上一站條碼
  - 顯示條碼選擇列表，支援多選（預設全選）
  - 顯示條碼的箱號、數量、貨態、容器等資訊
  - 貨態和容器顯示描述性文字（從 INI 配置讀取）
  - 新增「全選」和「全部取消」按鈕
  - 批量遷入時一次性寫入多筆記錄，提升效率
  - 自動篩除不良品（status = 'N'），不顯示在選擇列表中
- **後端緩存機制**：
  - 實現 Google Sheets 數據的內存緩存
  - 後端啟動時立即同步一次數據
  - 每 30 秒自動同步一次（可動態調整）
  - 所有讀取操作優先使用緩存，大幅減少 API 調用
  - 寫入操作後立即更新緩存，確保數據一致性
  - 智能錯誤處理：遇到 API 限流時自動延長同步間隔（指數退避）
  - 最多延長至 5 分鐘，成功後恢復為 30 秒
- **批量讀寫優化**：
  - 批量遷入時使用 `write_logs_batch` 一次性寫入多筆記錄
  - 批量檢查遷入記錄時使用 `batch_check_inbound_records` 減少 API 調用
  - 使用 `findall()` 和 `batch_get()` 優化讀取效率
  - 大幅提升系統性能，減少 Google Sheets API 調用次數

### 改進
- **遷出功能 UI/UX 優化**：
  - 遷出頁面改為可捲動設計，標題和關閉按鈕固定在頂部
  - 內容區域可捲動，支援查看所有內容
  - 使用 flexbox 布局，確保關閉按鈕始終可見
  - 最大高度限制為 90vh，避免覆蓋整個螢幕
  - 支援 iOS 平滑捲動（-webkit-overflow-scrolling: touch）
- **自動計算箱數預覽**：
  - 輸入數量並選擇容器後，即時顯示預估箱數
  - 良品和不良品分別計算和顯示
  - 使用不同顏色區分（良品綠色，不良品紅色）
- **遷出結果頁面優化**：
  - 分組顯示良品和不良品箱子
  - 良品箱子使用綠色背景，不良品箱子使用紅色背景
  - 顯示各自的箱數統計
  - 遷出資訊顯示在最上方，包含總箱子數、總數量、良品箱數、不良品箱數
- **批量遷入 UI 改進**：
  - 使用全屏模態對話框顯示條碼選擇列表
  - 標題和關閉按鈕固定在頂部
  - 列表可捲動，支援查看所有條碼
  - 「確認遷入」按鈕固定在底部
  - 數量顯示使用藍色粗體，更加醒目
- **錯誤訊息優化**：
  - 簡化數量不符的錯誤訊息，只顯示關鍵資訊
  - 從詳細的計算過程改為簡潔的「加總 X 件與投入量 Y 件不符」
- **後端 API 改進**：
  - `/api/scan/outbound` 支援同時處理良品和不良品
  - 向後兼容舊格式（單一 qty, container, status）
  - 返回數據包含良品箱數和不良品箱數統計
  - 批量寫入時使用 `write_logs_batch` 提升效率

### 修正
- **修復 Pydantic 警告**：
  - 在 `FirstStationRequest` 中添加 `model_config = {"protected_namespaces": ()}`
  - 解決 `model_code` 欄位與 Pydantic 保護命名空間衝突的警告
- **修復底部工作表捲動問題**：
  - 重新設計底部工作表結構，使用 flexbox 布局
  - 標題和關閉按鈕固定在頂部
  - 內容區域可捲動，確保所有內容都可見
- **修復函數未定義錯誤**：
  - 添加 `setupOutboundBoxCalculation` 函數定義
  - 修復遷出頁面打開時的 `ReferenceError`

### 技術細節
- **後端緩存實現**：
  - 使用 `threading.Lock` 確保線程安全
  - 使用 `threading.Thread` 實現後台同步
  - 實現指數退避策略處理 API 限流
  - 同步失敗計數達到 3 次時才延長間隔
- **批量操作優化**：
  - 批量遷入時先驗證所有條碼，然後一次性寫入
  - 使用 `worksheet.append_rows()` 批量寫入
  - 批量檢查時使用 `col_values()` 和 `findall()` 減少讀取量
- **前端狀態管理**：
  - 在 `AppState` 中添加 `currentInboundQty` 存儲投入量
  - 在 `AppState` 中添加 `statusOptions` 存儲貨態配置
  - 投入量查詢後存儲到狀態，供驗證使用

### 性能優化
- **Google Sheets API 調用大幅減少**：
  - 讀取操作幾乎全部使用緩存，API 調用減少 95% 以上
  - 批量寫入減少寫入 API 調用次數
  - 批量檢查減少讀取 API 調用次數
  - 智能同步間隔調整，避免 API 限流
- **響應速度提升**：
  - 讀取操作從數秒降低到毫秒級（使用緩存）
  - 批量遷入寫入時間從每筆 2 秒降低到批量一次性寫入
  - 批量檢查遷入記錄時間大幅縮短

### 文檔
- 更新 `CHANGELOG.md`：詳細記錄 0.2.0 版本的所有變更
- 更新 `VERSION`：版本號更新為 0.2.0

## [0.1.2] - 2025-01-XX

### 新增
- **智能條碼檢查邏輯優化**：
  - 本站條碼特殊處理：當本站掃到本站生成的條碼時，無論是否有記錄，都只允許查詢
  - 防止在錯誤站點操作：P1 站點掃到 P1 條碼時，隱藏遷入與遷出功能，直接顯示查詢頁面
  - 只有正確的站點掃到時才會出現對應的遷入或遷出功能
- **處理中動畫提示**：
  - 提交後顯示處理中動畫（旋轉 spinner）
  - 直到 Google Sheets 寫入完畢後才隱藏
  - 提供視覺反饋，改善使用者體驗
- **QR Code 彈出視窗**：
  - 遷出後的 QR Code 頁面改為彈出視窗
  - 右上角有關閉圖示
  - 遷出資訊顯示在最上方，各箱子明細依序列出，下載按鈕在最下方
- **新條碼 URL 格式優化**：
  - Sheet 中「新條碼」欄位的網址，domain 部分保持原始大小寫（不轉大寫）
  - 只有條碼部分轉為大寫

### 改進
- **條碼掃描邏輯優化**：
  - 更新優先級順序，新增「本站條碼」檢查為第三優先級
  - 下一站條碼在當前站點沒有記錄時，只允許查詢（不允許遷入）
  - 確保只有正確的站點才能進行遷入或遷出操作
- **前端自動功能切換**：
  - 當收到 `trace` 建議時，自動關閉底部工作表並執行查詢功能
  - 自動填入條碼並顯示追溯結果

### 文檔
- 更新 `BARCODE_SCAN_LOGIC.md`：記錄最新的邏輯流程和優先級順序
- 更新 `PRD.md`：添加智能條碼檢查與功能切換的詳細說明

## [0.1.1] - 2025-01-XX

### 新增
- **追溯查詢頁面改進**：
  - 改為獨立全屏頁面，不會自動關閉
  - 按製程站點時間順序排列（由早到晚）
  - 顯示各製程站的遷入時間、遷出時間、總耗時間
  - 顯示投入數量、產出良品、產出不良品
  - 顯示當站良率（產出良品/投入數量）
  - 頂部統計顯示：總數量、最終站良品、全製程不良品、直通率、全製程用時
  - 產品線和型號顯示：`產品線代號 - 機種代號 | 產品線名稱 - 機種名稱`

### 修正
- **當站良率計算**：修正為產出良品數量 / 投入數量（而非產出良品/產出總數）
- **投入數量計算**：修正為上一站的產出良品數量（而非所有 IN 記錄的總和）
- **統計信息計算**：
  - 全製程不良品 = 首站投入總數 - 最終站良品數
  - 直通率 = 最終站良品數 / 首站投入總數 × 100%
  - 全製程用時 = 累加各製程的總耗時間

### 改進
- **下拉式選單統一格式**：
  - 所有下拉式選單（產品線、機種、容器、製程站點）統一轉換為大寫顯示
  - 使用 INI 檔中定義的說明，統一轉換為大寫
- **Google Sheets 寫入統一格式**：
  - 所有寫入 Google Sheets 的字串欄位統一轉換為大寫
  - 包括：action、operator、order、process、sku、container、box_seq、status、scanned_barcode、new_barcode
- **同步寫入機制**：
  - 改為同步寫入 Google Sheets，檢查是否成功
  - 寫入失敗時返回錯誤，前端顯示錯誤訊息並允許重試
  - 網路錯誤時不關閉工作表，讓使用者可以重試
- **首站遷出按鈕顯示**：
  - 只有 P1 站才顯示首站遷出功能按鈕

### 優化
- **追溯查詢頁面**：
  - 移除產出數量顯示（只顯示產出良品和產出不良品）
  - 優化統計信息布局（3列改為2列顯示直通率和全製程用時）

## [0.1.0] - 2025-11-20

### 新增
- **PRD.md 與 Google Docs 雙向同步功能**：
  - 支援使用 MCP 工具同步（不需要憑證）
  - 支援使用 Google Docs API 同步（需要憑證）
  - 自動判斷同步方向
  - 記錄同步歷史
- **目錄結構優化**：
  - 創建 `mcp/` 目錄集中管理同步工具
  - 創建 `docs/` 目錄集中管理文檔
  - 創建 `scripts/` 目錄集中管理腳本
  - 根目錄檔案從 20+ 個減少到 6 個核心檔案
- **安全檢查工具**：
  - `check_security.sh` - 檢查即將提交的檔案
  - `check_git_history.sh` - 檢查 Git 歷史中的敏感資訊
  - `clean_git_history.sh` - 清理 Git 歷史中的敏感資訊
  - Git pre-commit hook 自動執行安全檢查
- **安全文檔**：
  - `docs/SECURITY.md` - 完整的安全指南
  - `docs/CLEAN_HISTORY_SUMMARY.md` - 清理總結
  - `docs/CLEAN_HISTORY_COMPLETE.md` - 清理完成指南

### 改進
- **目錄結構**：更清晰的目錄組織，易於維護
- **安全性**：完善的安全檢查機制，防止敏感資訊洩漏
- **文檔管理**：所有文檔集中管理，結構更清晰
- **腳本管理**：所有腳本集中管理，使用更方便

### 文檔
- `mcp/README.md` - MCP 工具說明
- `mcp/MCP_SYNC_GUIDE.md` - MCP 同步指南
- `mcp/PRD_SYNC_README.md` - PRD 同步詳細說明
- `mcp/QUICK_SYNC_GUIDE.md` - 快速同步指南
- `mcp/UPDATE_EXISTING_DOC.md` - 更新現有文件說明
- `docs/PROJECT_STRUCTURE.md` - 專案結構說明
- `docs/DIRECTORY_OPTIMIZATION.md` - 目錄優化總結
- `scripts/README.md` - 腳本使用說明

## [0.0.7] - 2025-01-XX

### 新增
- 完整測試框架：新增 pytest 測試框架和配置
- 單元測試套件：新增 5 個單元測試文件（條碼、配置、流程驗證、QR Code、Sheets）
- API 端點測試：新增完整的 API 端點測試，覆蓋所有 API 功能
- 整合測試：新增完整工作流程整合測試，通過 API 端點模擬前端調用（10 張工單）
- 中文測試報告：新增中文測試輸出功能，清楚顯示通過/失敗的測試項目
- 測試目錄結構：重組測試文件到 unit/、api/、integration/ 子目錄
- 測試文檔：新增完整的測試計劃和說明文檔（TEST_PLAN.md、TESTING.md 等）
- 測試啟動腳本：新增 run_tests.sh 和 run_tests_cn.py 方便執行測試

### 改進
- 測試覆蓋率：達到 77% 的測試覆蓋率
- 測試組織：按類型分類測試文件，結構更清晰
- 測試文檔集中管理：所有測試相關文檔統一放在 tests/ 目錄

### 修復
- 修復 QR Code 生成器 bytes 處理問題（img.to_string() 返回 bytes 的處理）
- 修復配置檔大小寫問題（ConfigParser 將鍵轉為小寫的處理）
- 修復條碼 CRC16 校驗碼測試問題
- 修復 API 測試中條碼校驗碼不正確的問題

### 測試
- 96 個測試用例，涵蓋所有核心功能
- 單元測試：條碼解析、生成、CRC16 校驗、配置載入、流程驗證等
- API 測試：所有 API 端點的完整測試
- 整合測試：完整生產流程測試（通過 API 端點）

### 文檔
- TEST_PLAN.md：詳細的測試計劃（598 行）
- TESTING.md：測試程序說明
- TEST_FIXES.md：測試修復記錄
- TEST_OUTPUT_CN.md：中文測試輸出說明
- TEST_STRUCTURE.md：測試目錄結構說明
- DOCS_INDEX.md：測試文檔索引

## [0.0.6] - 2025-01-XX

### 改進
- 站點代號統一為大寫：所有寫入 Google Sheets 的站點代號統一轉換為大寫格式
- 前端顯示統一為大寫：人機界面中顯示的站點代號統一轉換為大寫格式（例如：`P2 - 烘烤`）
- API 返回統一為大寫：所有 API 返回的站點資訊（`current_station`、`next_station`、`prev_station`）統一轉換為大寫
- Google Sheets 寫入邏輯優化：寫入時自動適應 Sheet 中的實際欄位順序，支援手動變更欄位順序

### 修復
- 修復寫入 Google Sheets 時站點代號為小寫的問題
- 修復前端界面顯示站點代號為小寫的問題
- 修復手動變更 Sheet 欄位順序時資料寫入錯誤欄位的問題

### 技術細節
- 寫入 Sheet 時會讀取實際標題列，建立標題到欄位的映射，確保資料寫入正確的欄位
- 所有站點相關的資料處理都統一轉換為大寫，保持一致性

## [0.0.5] - 2025-01-XX

### 新增
- 部分條碼解析功能：新增 `parse_partial()` 方法，支援解析不完整的條碼（例如：`251119AB-ZZ-AC001`）
- 智能條碼檢查 API：新增 `/api/scan/check` 端點，自動判斷條碼應該使用哪個功能（遷入、遷出、首站遷出）
- 智能掃描按鈕：前端新增「掃描條碼（智能識別）」按鈕，自動檢查條碼並跳轉到對應功能
- 站點特定遷出記錄檢查：新增 `has_outbound_record_at_station()` 方法，檢查條碼在指定站點是否有遷出記錄
- 新工單條碼格式支援：支援新工單條碼格式（工單號-ZZ-SKU），後續欄位為空
- 自動填入產品資訊：檢測到 ZZ 製程時，自動從 SKU 提取產品線和機種並填入首站遷出表單

### 改進
- 條碼檢查邏輯優化：根據條碼的製程代號與當前站點的關係，智能判斷應該使用遷入還是遷出功能
- 跨站點遷入邏輯：遷入時只檢查當前站點的遷出記錄，而不是所有站點的遷出記錄
- 首站遷出 domain 整合：首站遷出時將包含 domain 的完整條碼 URL 寫入 Google Sheets 和生成 QR Code
- 條碼清理邏輯：前端和後端都支援清理 `b=` 前綴，正確處理 URL 參數格式的條碼
- 機種代碼匹配：前端自動匹配機種代碼，處理前導零的差異（例如：`001` 和 `1`）

### 修復
- 修復首站遷出時新條碼未包含 domain 的問題
- 修復跨站點遷入時被錯誤拒絕的問題（例如：P2 讀取 P1 條碼時）
- 修復不完整條碼（如 `251119AB-ZZ`）無法解析的問題

### API 端點
- `POST /api/scan/check` - 智能條碼檢查，返回建議的操作類型

### 技術細節
- 條碼解析支援兩種模式：完整解析（34碼）和部分解析（至少包含工單號和製程代號）
- ZZ 製程（新工單）跳過 CRC16 驗證，因為可能是不完整的條碼
- 智能檢查邏輯：根據條碼製程代號與當前站點的關係，以及當前站點的遷出記錄，決定建議的操作

## [0.0.4] - 2025-01-XX

### 新增
- 綜合設定檔：`config/settings.ini` 用於存放系統綜合設定（包含 IP domain 設定）
- Domain 整合：遷出時自動將 domain 寫入新條碼 URL 並記錄到 Google Sheets
- 條碼記錄查詢：新增 `get_logs_by_barcode()` 方法，可根據條碼查詢歷史記錄
- 遷出記錄檢查：新增 `has_outbound_record()` 方法，檢查條碼是否有遷出記錄
- 智能功能切換：遷入時自動檢查條碼是否有 OUT 記錄，如有則自動切換到遷出功能

### 改進
- 流程驗證大小寫處理：統一將站點代號轉換為大寫進行比較，解決 P2 和 p2 不一致的問題
- 條碼匹配邏輯：優化條碼匹配，正確處理包含 domain 的條碼（例如：`http://localhost:8000/b=條碼`）
- 多次遷出支援：同一條碼可被遷出多次（例如：良品一批、不良品一批）
- 自動切換邏輯：下游站點掃到上游製程條碼時，如有 OUT 記錄則自動切換到遷出功能

### 修復
- 修復流程驗證中大小寫不一致導致的驗證失敗問題

### API 端點
- 遷入 API 新增智能檢查：自動判斷條碼是否有 OUT 記錄並返回切換提示

### 設定檔
- `config/settings.ini` - 綜合設定檔（包含 domain 設定）

## [0.0.3] - 2025-01-XX

### 新增
- QR Code 生成功能：提交成功後自動生成並顯示 QR Code SVG
- QR Code 下載功能：提供下載按鈕，可下載 QR Code 為 SVG 檔案
- QR Code 配置檔：`config/qrcode.ini` 用於設定 QR Code 大小、容錯率、定位點形狀和 logo 比例
- 工單號自動轉大寫：前端輸入和後端寫入時自動轉換為大寫
- 容器下拉選單：遷出和首站遷出功能改為從 `config/container.ini` 動態載入容器選項
- 站點中文名稱顯示：主頁面頂部顯示站點時同時顯示中文名稱（例如：P1 - 射出）
- 製程站點動態載入：設定頁面的站點選單從 `config/process.ini` 動態載入
- URL 重定向支援：新增 `/b=條碼` 路徑重定向，支援 QR code 中沒有 `?` 的情況
- 條碼解析功能：支援移除所有 `-` 後按固定位置解析條碼
- 智能工單識別：自動識別 ZZ 製程（新工單），自動切換到首站遷出功能

### 改進
- 產品線與機種選擇：系統自動從 ini 檔案反查代號並組合成 SKU
- 容器選擇：改為下拉選單，顯示「代號 - 容量」格式
- 站點顯示：主頁面和設定頁面都顯示「代號 - 中文名稱」格式
- 成功訊息：儲存設定時顯示站點中文名稱

### API 端點
- `GET /api/config/containers` - 取得容器選項
- `GET /api/config/processes` - 取得製程站點選項
- `GET /b={barcode}` - URL 重定向支援（QR code 掃描）

### 設定檔
- `config/qrcode.ini` - QR Code 生成設定（大小、容錯率、定位點形狀、logo 比例）

### 依賴
- `qrcode[pil]==7.4.2` - QR Code 生成庫

## [0.0.2] - 2025-01-XX

### 新增
- QR Code 掃描支援：從 URL 參數自動解析條碼並填入
- 支援手機條碼掃描器掃描 QR code 後自動開啟瀏覽器並帶入條碼
- 自動開啟遷入功能並聚焦到條碼輸入框

### 改進
- 簡化 URL 參數格式：使用 `?b=條碼` 取代 `?barcode=條碼`，減少 QR code 字數
- 未登入時保存條碼參數，登入後自動處理

## [0.0.1] - 2025-01-XX

### 新增
- 工廠製程物流追溯與分析系統初始版本
- FastAPI 後端服務
- iOS 風格行動端前端介面
- 條碼解析與生成功能（34碼條碼，含CRC16校驗）
- 製程流程驗證（防呆檢查）
- Google Sheets 整合（記錄遷入/遷出）
- 產品線與機種選擇功能（取代直接輸入SKU）
  - 產品線下拉選單（從 config/series.ini 讀取）
  - 機種下拉選單（從 config/model.ini 讀取）
  - 系統自動組合成 SKU 代號

### 功能
- 貨物遷入（IN）：驗證流程並記錄
- 貨物遷出（OUT）：生成新條碼並記錄
- 首站遷出（FIRST）：手動輸入工單資訊，生成第一個條碼
- 追溯查詢（TRACE）：查詢工單的時間軸與良率統計

### 設定檔
- `config/process.ini` - 製程站點定義
- `config/series.ini` - 產品系列定義
- `config/model.ini` - 產品機型定義
- `config/flow.ini` - 製程流程定義
- `config/container.ini` - 容器定義
- `config/status.ini` - 貨態定義

### API 端點
- `GET /` - 前端頁面
- `POST /api/scan/inbound` - 貨物遷入
- `POST /api/scan/outbound` - 貨物遷出
- `POST /api/scan/first` - 首站遷出
- `POST /api/scan/trace` - 追溯查詢
- `GET /api/config/series` - 取得產品線選項
- `GET /api/config/models` - 取得機種選項

